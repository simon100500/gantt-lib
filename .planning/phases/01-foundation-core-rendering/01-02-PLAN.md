---
phase: 01-foundation-core-rendering
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/utils/dateUtils.ts
  - src/utils/geometry.ts
  - src/__tests__/dateUtils.test.ts
  - src/__tests__/geometry.test.ts
autonomous: true
requirements: [QL-03]
must_haves:
  truths:
    - "Date parsing converts strings to UTC Date objects"
    - "Date arithmetic uses UTC-only methods to prevent DST bugs"
    - "Geometry calculations convert dates to pixel positions"
    - "All functions have unit tests with >80% coverage"
    - "Tests pass with `npm test`"
  artifacts:
    - path: "src/types/index.ts"
      provides: "TypeScript interfaces for Task and Gantt data structures"
      exports: ["Task", "GanttDateRange"]
    - path: "src/utils/dateUtils.ts"
      provides: "UTC-only date manipulation functions"
      exports: ["parseUTCDate", "getMonthDays", "getDayOffset", "isToday"]
    - path: "src/utils/geometry.ts"
      provides: "Date-to-pixel conversion calculations"
      exports: ["calculateTaskBar", "calculateGridWidth"]
    - path: "src/__tests__/dateUtils.test.ts"
      provides: "Date utility tests"
      min_lines: 30
    - path: "src/__tests__/geometry.test.ts"
      provides: "Geometry calculation tests"
      min_lines: 20
  key_links:
    - from: "src/utils/dateUtils.ts"
      to: "date-fns"
      via: "import statements"
      pattern: "from 'date-fns'"
    - from: "src/utils/geometry.ts"
      to: "src/utils/dateUtils.ts"
      via: "import date utilities"
      pattern: "from.*dateUtils"
    - from: "src/types/index.ts"
      to: "src/utils/*.ts"
      via: "type imports"
      pattern: "from.*types"
---

<objective>
Create UTC-safe date utilities and geometry calculation engine with full unit test coverage using TDD methodology.

Purpose: These utilities are the foundation for all date and positioning logic. Using TDD ensures correctness and prevents DST bugs before they reach the UI.

Output: Tested date utilities (parseUTCDate, getMonthDays, getDayOffset, isToday) and geometry functions (calculateTaskBar, calculateGridWidth) with comprehensive test coverage.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-rendering/01-CONTEXT.md
@.planning/phases/01-foundation-core-rendering/01-RESEARCH.md
</context>

<feature>
  <name>Date Utilities and Geometry Engine</name>
  <files>src/utils/dateUtils.ts, src/utils/geometry.ts, src/types/index.ts, src/__tests__/dateUtils.test.ts, src/__tests__/geometry.test.ts</files>
  <behavior>
    Date Utilities:
    - parseUTCDate(string|Date) → Date: Parse date as UTC (append 'Z' to strings)
    - getMonthDays(date) → Date[]: Get all days in month (UTC)
    - getDayOffset(date, monthStart) → number: Days from month start (0-based)
    - isToday(date) → boolean: Check if date is today (UTC comparison)

    Geometry:
    - calculateTaskBar(taskStart, taskEnd, monthStart, dayWidth) → {left, width}: Pixel positioning
    - calculateGridWidth(daysInMonth, dayWidth) → number: Total grid width

    Edge cases to test:
    - DST transition dates (March and November)
    - Month boundaries (Feb 28 → Mar 1)
    - Leap years (Feb 29)
    - Negative offsets (tasks before month start)
    - Zero/negative durations
  </behavior>
  <implementation>
    Follow patterns from RESEARCH.md "Code Examples" section:
    1. Use date-fns UTC methods exclusively
    2. Parse strings with 'Z' suffix for UTC
    3. Round all pixel calculations to integers
    4. Add +1 to duration for inclusive end dates
    5. Export TypeScript types for all inputs/outputs
  </implementation>
</feature>

<verification>
1. Run `npm test` - all tests pass
2. Run `npm test -- --coverage` - coverage >80% for utility files
3. Test specifically with DST dates (March 10, November 5) to verify UTC handling
4. Confirm no TypeScript errors
</verification>

<success_criteria>
- [ ] All date utility functions implemented with UTC-only logic
- [ ] All geometry calculation functions implemented with integer rounding
- [ ] Unit tests cover normal cases + edge cases (DST, leap years, boundaries)
- [ ] Test coverage exceeds 80%
- [ ] All tests pass
- [ ] TypeScript types exported for all public APIs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-rendering/01-02-SUMMARY.md`
</output>
