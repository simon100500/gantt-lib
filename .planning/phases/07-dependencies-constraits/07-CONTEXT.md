# Phase 7: dependencies constraits - Context

**Gathered:** 2026-02-22
**Status:** Ready for planning

<domain>
## Phase Boundary

Реализация ограничений зависимостей при перетаскивании для связей типа FS (Finish-to-Start). Два режима: жёсткий (каскадное смещение цепочки) и мягкий (только изменение лага). Другие типы связей (SS, FF, SF) — вне скопа этой фазы.

</domain>

<decisions>
## Implementation Decisions

### Режим ограничений

- `disableConstraints={false}` (по умолчанию) → **жёсткий режим**: цепочка задач движется как монолит
- `disableConstraints={true}` → **мягкий режим**: задача движется свободно, меняется только лаг связи

**Поведение жёсткого режима (FS):**
- Двигаем предшественника (родителя) → все потомки цепочки сдвигаются вместе, оба направления
- Двигаем последователя (ребёнка) **вправо** → ребёнок + его потомки сдвигаются, лаг между родителем и ребёнком увеличивается (типичный сценарий просрочки)
- Двигаем последователя **влево** → упирается в `startDate` родителя, дальше не идёт; задача просто останавливается без визуальной подсказки

**Поведение мягкого режима (FS):**
- Задача перемещается свободно в любом направлении
- Лаг связи пересчитывается согласно новому положению
- Нарушение FS (отрицательный лаг) визуально не отображается — стрелка всегда одинаковая

### Каскадное поведение

- Глубина каскада не ограничена (A→B→C→D — двигаем A, сдвигаются все)
- При нескольких предшественниках (A→C, B→C): сдвиг C определяется только перетаскиваемой задачей; лаги остальных связей пересчитываются
- Во время драга все задачи цепочки движутся в реальном времени — визуальный preview без выделения
- SS/FF/SF — поведение ограничений для этих типов оставить для следующей фазы

### Визуализация нарушений

- В мягком режиме стрелка всегда одинаковая — нет визуального указания на нарушение FS
- В жёстком режиме все задачи цепочки выглядят одинаково при перетаскивании
- При упоре ребёнка в `startDate` родителя: задача просто останавливается, граница не подсвечивается

### API обратных вызовов

- `onChange(task: Task)` — остаётся без изменений для одиночных перемещений (мягкий режим и обычный drag без зависимостей)
- `onCascade(tasks: Task[])` — новый колбэк, вызывается при каскадном смещении; включает все изменившиеся задачи, **включая перетаскиваемую**
- Как именно передаётся изменение лага в мягком режиме (через `onChange` с обновлённым `dependencies[]` или отдельный колбэк) — **Claude's Discretion**

### Claude's Discretion

- Как передавать изменённый лаг в мягком режиме (сигнатура/способ)
- Внутренняя структура данных для обхода цепочки (BFS vs DFS)
- Обработка edge case: циклические зависимости при каскаде (цикл-детекция уже есть из Phase 6)

</decisions>

<specifics>
## Specific Ideas

- Жёсткий режим — поведение по умолчанию (disableConstraints=false), мягкий — opt-in
- Граница для ребёнка влево — `startDate` родителя (не `endDate`): ребёнок может иметь отрицательный лаг (стартовать до окончания родителя), но не раньше начала родителя
- Типичный пользовательский сценарий: «задача просрочена, нужно сдвинуть всех последователей» — ребёнок вправо, лаг растёт, цепочка тащится

</specifics>

<deferred>
## Deferred Ideas

- SS, FF, SF — ограничения и каскад для других типов связей → следующая фаза
- Визуальная подсветка нарушённых связей (цвет стрелки) → отдельная фаза по визуализации

</deferred>

---

*Phase: 07-dependencies-constraits*
*Context gathered: 2026-02-22*
