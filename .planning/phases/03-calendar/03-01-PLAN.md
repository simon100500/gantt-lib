---
phase: 03-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/dateUtils.ts
  - src/utils/geometry.ts
  - src/types/index.ts
  - src/app/globals.css
autonomous: true
requirements:
  - API-03
  - DX-01
  - DX-02
  - DX-03
  - DX-04

must_haves:
  truths:
    - "User can see full calendar grid showing complete months (from 1st to last day)"
    - "User can see weekend days highlighted with pink background"
    - "Calendar grid expands to include full months touched by task dates"
  artifacts:
    - path: "src/utils/dateUtils.ts"
      provides: "Multi-month date range calculation, weekend detection"
      exports: ["getMultiMonthDays", "isWeekend", "getMonthSpans"]
    - path: "src/utils/geometry.ts"
      provides: "Grid line and weekend background calculations"
      exports: ["calculateGridLines", "calculateWeekendBlocks"]
    - path: "src/types/index.ts"
      provides: "Type definitions for calendar grid structures"
      contains: "MonthSpan, GridLine, WeekendBlock"
    - path: "src/app/globals.css"
      provides: "CSS variables for weekend background and separator styling"
      contains: "--gantt-weekend-background, --gantt-month-separator-color, --gantt-week-separator-color"
  key_links:
    - from: "src/utils/dateUtils.ts"
      to: "date-fns"
      via: "format(), getDay(), getMonth() functions"
      pattern: "import.*format.*from 'date-fns'"
    - from: "src/utils/geometry.ts"
      to: "src/utils/dateUtils.ts"
      via: "parseUTCDate, isWeekend functions"
      pattern: "import.*parseUTCDate|isWeekend.*from"
---

<objective>
Create utility functions and types for multi-month calendar grid calculation, supporting weekend detection, month/week separators, and full-month range expansion.

Purpose: These utilities are the foundation for the two-row header and grid background rendering. Without them, the calendar cannot display multi-month ranges or identify weekends for highlighting.

Output: Working date utilities for multi-month ranges, geometry calculations for grid lines, TypeScript types for calendar structures, and CSS variables for theming.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-calendar/03-CONTEXT.md
@.planning/phases/03-calendar/03-RESEARCH.md

@src/utils/dateUtils.ts
@src/utils/geometry.ts
@src/types/index.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Add multi-month date range utilities</name>
  <files>src/utils/dateUtils.ts</files>
  <action>
Add the following functions to src/utils/dateUtils.ts:

1. **getMultiMonthDays(tasks: Task[]): Date[]**
   - Find min/max dates from all tasks
   - Extend range to full months (1st of first month to last day of last month)
   - Return array of all Date objects in range
   - Use UTC-only date arithmetic (Date.UTC constructor)
   - Handle empty task array by returning current month

2. **isWeekend(date: Date): boolean**
   - Check if date is Saturday (6) or Sunday (0) using getUTCDay()
   - Return boolean

3. **getMonthSpans(dateRange: Date[]): Array<{ month: Date; days: number; startIndex: number }>**
   - Calculate how many days each month spans in the date range
   - Track start index for each month
   - Return array of span objects

Implementation must follow existing patterns:
- Use Date.UTC() for all date arithmetic (prevents DST bugs)
- Parse task dates with parseUTCDate() before comparison
- Round no values (return exact Date objects)

DO NOT:
- Use date-fns for month boundary calculations (use native Date.UTC)
- Add locale handling here (done in components)
- Create new utility files (add to existing dateUtils.ts)
  </action>
  <verify>
npm test passes (existing 59 tests + any new tests)
TypeScript compilation: npx tsc --noEmit
  </verify>
  <done>
getMultiMonthDays returns full month range (e.g., tasks Mar 25 - May 5 returns Mar 1 - May 31)
isWeekend correctly identifies Saturday/Sunday using UTC
getMonthSpans calculates correct day counts per month
All functions use UTC-only date arithmetic
  </done>
</task>

<task type="auto">
  <name>Add grid line and weekend calculation utilities</name>
  <files>src/utils/geometry.ts</files>
  <action>
Add the following functions to src/utils/geometry.ts:

1. **calculateGridLines(dateRange: Date[], dayWidth: number): Array<{ x: number; isMonthStart: boolean; isWeekStart: boolean }>**
   - Map each date to vertical line position
   - Detect month boundaries (date.getUTCDate() === 1)
   - Detect week starts (Monday: date.getUTCDay() === 1)
   - Return array of line objects with x position and flags

2. **calculateWeekendBlocks(dateRange: Date[], dayWidth: number): Array<{ left: number; width: number }>**
   - Find contiguous weekend blocks (Saturday-Sunday sequences)
   - Calculate left position and width for each block
   - Handle edge case where range starts/ends on weekend

Implementation must follow existing patterns:
- Use Math.round() for all pixel values
- Use isWeekend() from dateUtils for weekend detection
- Left position = index * dayWidth
- Width = dayCount * dayWidth

DO NOT:
- Create separate grid rendering logic here (just calculations)
- Add visual styling (done in CSS/components)
- Use floating-point pixel values (always Math.round)
  </action>
  <verify>
npm test passes
TypeScript compilation: npx tsc --noEmit
  </verify>
  <done>
calculateGridLines returns correct x positions for all dates
Month start detection works across year boundaries
Weekend blocks correctly span Saturday-Sunday
All pixel values are rounded integers
  </done>
</task>

<task type="auto">
  <name>Add calendar type definitions and CSS variables</name>
  <files>src/types/index.ts src/app/globals.css</files>
  <action>
1. **Add to src/types/index.ts:**

```typescript
/**
 * Represents a month span in the calendar header
 */
export interface MonthSpan {
  /** First day of the month (UTC) */
  month: Date;
  /** Number of days this month spans in the visible range */
  days: number;
  /** Start index in the date range array */
  startIndex: number;
}

/**
 * Represents a vertical grid line
 */
export interface GridLine {
  /** X position in pixels */
  x: number;
  /** True if this line is at the start of a month */
  isMonthStart: boolean;
  /** True if this line is at the start of a week (Monday) */
  isWeekStart: boolean;
}

/**
 * Represents a weekend background block
 */
export interface WeekendBlock {
  /** Left position in pixels */
  left: number;
  /** Width in pixels */
  width: number;
}
```

2. **Add to src/app/globals.css (in :root section):**

```css
/* Calendar Grid - Weekend */
--gantt-weekend-background: #fee2e2;
--gantt-weekend-border: #fca5a5;

/* Calendar Grid - Separators */
--gantt-month-separator-width: 2px;
--gantt-month-separator-color: #374151;
--gantt-week-separator-width: 1px;
--gantt-week-separator-color: #d1d5db;
--gantt-day-line-width: 1px;
--gantt-day-line-color: #f3f4f6;
```

Follow Claude's discretion from CONTEXT for exact values:
- Weekend: #fee2e2 (medium pink, Tailwind red-100)
- Month separator: 2px, #374151 (dark gray)
- Week separator: 1px, #d1d5db (medium gray)
- Day line: 1px, #f3f4f6 (light gray)

DO NOT:
- Add other color variables (existing ones sufficient)
- Use different hex codes than specified above
- Add component-specific styles here (use CSS modules)
  </action>
  <verify>
npm test passes
TypeScript compilation: npx tsc --noEmit
CSS variables are defined in :root
  </verify>
  <done>
MonthSpan, GridLine, WeekendBlock types exist and are exported
All CSS variables defined in globals.css
TypeScript compiles without errors
Types are importable from @/types
  </done>
</task>

</tasks>

<verification>
Overall verification steps after completing all tasks:

1. Run tests: npm test (all 59+ tests pass)
2. TypeScript check: npx tsc --noEmit (no errors)
3. Verify utilities are importable:
   - import { getMultiMonthDays, isWeekend, getMonthSpans } from '@/utils/dateUtils'
   - import { calculateGridLines, calculateWeekendBlocks } from '@/utils/geometry'
   - import { MonthSpan, GridLine, WeekendBlock } from '@/types'
4. Verify CSS variables exist: grep globals.css for gantt-weekend, gantt-month-separator, gantt-week-separator, gantt-day-line
</verification>

<success_criteria>
- Multi-month date range utility calculates full month boundaries from task dates
- Weekend detection function correctly identifies Saturday/Sunday using UTC
- Month span calculation returns correct day counts per month
- Grid line calculation returns x positions with month/week start flags
- Weekend block calculation returns contiguous weekend positions and widths
- All new types (MonthSpan, GridLine, WeekendBlock) are exported and usable
- CSS variables for weekend background and separators are defined
- All existing tests still pass (59 tests)
- TypeScript compilation succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-01-SUMMARY.md`
</output>
