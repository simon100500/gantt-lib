---
phase: 03-calendar
plan: 04
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
  - 03-03
files_modified:
  - src/components/GanttChart/GanttChart.tsx
  - src/components/GanttChart/GanttChart.module.css
  - src/app/page.tsx
autonomous: false
requirements:
  - API-03
  - DX-01
  - DX-02
  - DX-03
  - DX-04

must_haves:
  truths:
    - "User can see full calendar grid when viewing page"
    - "User can drag task bars to move/resize them"
    - "Grid lines align perfectly with header columns"
    - "Header scrolls horizontally in sync with task area"
    - "Weekend days have pink background across all rows"
    - "Calendar shows full months even when tasks don't span entire month"
  artifacts:
    - path: "src/components/GanttChart/GanttChart.tsx"
      provides: "Main chart component with multi-month support and grid background"
      min_lines: 100
    - path: "src/components/GanttChart/GanttChart.module.css"
      provides: "Styles for synchronized scrolling and grid layout"
    - path: "src/app/page.tsx"
      provides: "Demo page showing multi-month calendar grid"
  key_links:
    - from: "src/components/GanttChart/GanttChart.tsx"
      to: "src/utils/dateUtils.ts"
      via: "getMultiMonthDays"
      pattern: "getMultiMonthDays"
    - from: "src/components/GanttChart/GanttChart.tsx"
      to: "src/components/GridBackground"
      via: "GridBackground component import"
      pattern: "import.*GridBackground"
    - from: "src/components/GanttChart/GanttChart.tsx"
      to: "src/components/TimeScaleHeader"
      via: "Updated TimeScaleHeader with two-row layout"
      pattern: "TimeScaleHeader"
    - from: "src/components/GanttChart/GanttChart.tsx"
      to: "src/components/TaskRow"
      via: "TaskRow component for rendering tasks"
      pattern: "TaskRow"
---

<objective>
Integrate all Phase 3 components into GanttChart: multi-month date range calculation, GridBackground rendering, two-row TimeScaleHeader, and synchronized scrolling.

Purpose: This is the integration plan that brings together all the work from previous plans (utilities, GridBackground, TimeScaleHeader) into a working multi-month calendar grid with weekend highlighting and proper header-body synchronization.

Output: Fully functional multi-month Gantt chart with two-row header, grid lines, weekend highlighting, and synchronized scrolling.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-calendar/03-CONTEXT.md
@.planning/phases/03-calendar/03-RESEARCH.md
@.planning/phases/03-calendar/03-01-SUMMARY.md
@.planning/phases/03-calendar/03-02-SUMMARY.md
@.planning/phases/03-calendar/03-03-SUMMARY.md

@src/components/GanttChart/GanttChart.tsx
@src/components/GanttChart/GanttChart.module.css
@src/app/page.tsx
@src/components/TaskRow/TaskRow.tsx
</context>

<tasks>

<task type="auto">
  <name>Update GanttChart to use multi-month range and GridBackground</name>
  <files>src/components/GanttChart/GanttChart.tsx</files>
  <action>
Update src/components/GanttChart/GanttChart.tsx:

1. **Add imports:**
```typescript
import { getMultiMonthDays } from '../../utils/dateUtils';
import GridBackground from '../GridBackground';
import type { Task } from './GanttChart';
```

2. **Remove month prop (no longer needed):**
   - Remove `month?: Date | string` from GanttChartProps interface
   - Remove `month = new Date()` from component props
   - Document in JSDoc that date range is calculated from tasks

3. **Replace monthDays with dateRange:**
```typescript
// Calculate multi-month date range from tasks
const dateRange = useMemo(() => getMultiMonthDays(tasks), [tasks]);
```

4. **Add scroll refs:**
```typescript
const scrollContainerRef = useRef<HTMLDivElement>(null);
const headerScrollRef = useRef<HTMLDivElement>(null);
```

5. **Add scroll sync handler:**
```typescript
const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {
  if (headerScrollRef.current) {
    headerScrollRef.current.scrollLeft = e.currentTarget.scrollLeft;
  }
}, []);
```

6. **Update gridWidth calculation:**
```typescript
const gridWidth = useMemo(
  () => Math.round(dateRange.length * dayWidth),
  [dateRange.length, dayWidth]
);
```

7. **Calculate total grid height:**
```typescript
const totalGridHeight = useMemo(
  () => tasks.length * rowHeight,
  [tasks.length, rowHeight]
);
```

8. **Update render structure:**
   - Wrap TimeScaleHeader in a div with ref={headerScrollRef}
   - Add GridBackground component before TodayIndicator
   - Add onScroll handler to task area container
   - Update monthStart to use dateRange[0]

9. **Update monthStart calculation:**
```typescript
const monthStart = useMemo(() => {
  if (dateRange.length === 0) {
    return new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), 1));
  }
  const firstDay = dateRange[0];
  return new Date(Date.UTC(firstDay.getUTCFullYear(), firstDay.getUTCMonth(), 1));
}, [dateRange]);
```

10. **Update TodayIndicator visibility check:**
```typescript
// Only render if today is in the visible date range
const todayInRange = useMemo(() => {
  const now = new Date();
  const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
  return dateRange.some(day => day.getTime() === today.getTime());
}, [dateRange]);
```

DO NOT:
- Keep the old month-based calculation logic
- Remove existing drag-and-drop functionality
- Change TaskRow props (monthStart still needed for positioning)
- Break the onChange callback mechanism
  </action>
  <verify>
npm test passes
TypeScript compilation: npx tsc --noEmit
Component compiles without errors
  </verify>
  <done>
GanttChart uses getMultiMonthDays for date range
GridBackground component is integrated
Scroll refs are created
Scroll sync handler is implemented
TimeScaleHeader is wrapped in scrollable div
Task area has onScroll handler
monthStart calculated from dateRange[0]
  </done>
</task>

<task type="auto">
  <name>Update GanttChart CSS for synchronized scrolling</name>
  <files>src/components/GanttChart/GanttChart.module.css</files>
  <action>
Update src/components/GanttChart/GanttChart.module.css:

1. **Add scroll container styles:**
```css
.headerScrollContainer {
  overflow-x: auto;
  overflow-y: hidden;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.headerScrollContainer::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

.taskScrollContainer {
  overflow-x: auto;
  overflow-y: visible;
  position: relative;
}
```

2. **Update .chartWrapper:**
```css
.chartWrapper {
  display: inline-block;
  min-width: 100%;
  border: 1px solid var(--gantt-grid-line-color, #e0e0e0);
  background-color: var(--gantt-cell-background, #ffffff);
}
```

3. **Keep existing .container and .taskArea styles:**
```css
.container {
  width: 100%;
  overflow-x: auto;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.taskArea {
  position: relative;
  background-color: var(--gantt-cell-background, #ffffff);
}
```

The header scrollbar is hidden but allows programmatic scrolling via the scroll sync handler.

DO NOT:
- Remove existing styles that are still needed
- Add hover effects to scroll containers
- Use JavaScript scrolling (use scrollLeft assignment)
- Break existing task area styling
  </action>
  <verify>
npm test passes
CSS module imports correctly
  </verify>
  <done>
Header scroll container has hidden scrollbar
Task scroll container allows horizontal scrolling
Scroll sync works via scrollLeft assignment
Existing styles are preserved
  </done>
</task>

<task type="auto">
  <name>Update demo page with multi-month task examples</name>
  <files>src/app/page.tsx</files>
  <action>
Update src/app/page.tsx to demonstrate multi-month functionality:

1. **Update sample tasks to span multiple months:**
   - Create tasks that span from March to May
   - Include tasks in different months
   - Show tasks that start/end in different months

2. **Remove month prop from GanttChart:**
```typescript
<GanttChart
  tasks={tasks}
  dayWidth={40}
  rowHeight={40}
  headerHeight={40}
  onChange={handleTasksChange}
/>
```

3. **Add documentation:**
```typescript
/**
 * Multi-month Gantt chart demo
 *
 * The calendar automatically shows full months based on task date ranges.
 * For example, if tasks span from March 25 to May 5, the calendar shows
 * the complete months of March, April, and May (March 1 - May 31).
 */
```

4. **Keep existing features:**
   - onChange handler for state persistence
   - use100Tasks toggle for performance testing
   - Color customization examples

DO NOT:
- Remove the onChange handler
- Remove the use100Tasks toggle
- Hardcode the month prop (it's been removed)
- Reduce task variety (keep demonstrating edge cases)
  </action>
  <verify>
npm run dev starts successfully
Page loads without errors
Multi-month calendar is visible
  </verify>
  <done>
Demo page shows multi-month calendar
Tasks span multiple months
No month prop passed to GanttChart
onChange handler works correctly
Documentation is updated
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify multi-month Gantt chart integration</name>
  <files>(checkpoint - no files modified)</files>
  <what-built>Complete multi-month Gantt chart integration with two-row header, grid lines, weekend highlighting, and synchronized scrolling</what-built>
  <how-to-verify>
1. Start dev server: npm run dev
2. Open http://localhost:3000
3. Verify the following:
   - Header shows two rows (month names on top, day numbers below)
   - Month names are in Russian (Январь, Февраль, etc.)
   - Weekend columns have pink background
   - Thick dark lines separate months
   - Thinner lighter lines separate weeks
   - Vertical grid lines span full height
   - Header scrolls horizontally in sync with task area
   - Task bars can be dragged to move/resize
   - Calendar shows full months (not just task date range)
4. Test drag operations:
   - Drag a task to move it
   - Drag task edge to resize
   - Verify changes persist via onChange
5. Test scrolling:
   - Scroll task area horizontally
   - Verify header stays in sync
   - Verify grid lines align with header columns
  </how-to-verify>
  <resume-signal>Type "approved" if all verification checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Overall verification steps after completing all tasks:

1. Run tests: npm test (all 59+ tests pass)
2. TypeScript check: npx tsc --noEmit (no errors)
3. Build check: npm run build (production build succeeds)
4. Dev server starts: npm run dev
5. Manual verification checkpoint confirms all visual features work correctly
</verification>

<success_criteria>
- GanttChart calculates multi-month date range from tasks automatically
- Calendar displays complete months (1st to last day) based on task dates
- Two-row header displays correctly with Russian month names
- GridBackground renders vertical lines and weekend backgrounds
- Header and task area scroll horizontally in sync
- Grid lines align perfectly with header columns
- Weekend columns have pink background across all rows
- Month separators are thick and dark
- Week separators are thin and light
- Drag-and-drop still works for moving and resizing tasks
- onChange callback persists changes
- All existing tests pass
- TypeScript compilation succeeds
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar/03-04-SUMMARY.md`
</output>
