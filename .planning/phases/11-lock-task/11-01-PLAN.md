---
phase: 11-lock-task
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gantt-lib/src/types/index.ts
  - packages/gantt-lib/src/components/GanttChart/GanttChart.tsx
  - packages/gantt-lib/src/hooks/useTaskDrag.ts
  - packages/gantt-lib/src/components/TaskRow/TaskRow.tsx
  - packages/gantt-lib/src/components/TaskRow/TaskRow.css
autonomous: true
requirements:
  - DX-01
  - INT-01
  - INT-02

must_haves:
  truths:
    - "Hovering a locked task bar shows cursor: not-allowed instead of grab"
    - "Attempting to drag or resize a locked task has zero effect — no drag state is set, no RAF loop starts"
    - "A lock icon (inline SVG padlock) appears to the left of the date-range text on locked task bars"
    - "Unlocked tasks are visually and functionally unchanged"
    - "Toggling task.locked from false to true causes the task bar to re-render with the icon and not-allowed cursor (arePropsEqual includes locked)"
  artifacts:
    - path: "packages/gantt-lib/src/types/index.ts"
      provides: "locked?: boolean on public Task interface"
      contains: "locked"
    - path: "packages/gantt-lib/src/components/GanttChart/GanttChart.tsx"
      provides: "locked?: boolean on internal Task interface (kept in sync)"
      contains: "locked"
    - path: "packages/gantt-lib/src/hooks/useTaskDrag.ts"
      provides: "locked option + early return guard + cursor not-allowed"
      exports: ["useTaskDrag", "UseTaskDragOptions"]
    - path: "packages/gantt-lib/src/components/TaskRow/TaskRow.tsx"
      provides: "lock icon rendering + arePropsEqual update"
      min_lines: 30
    - path: "packages/gantt-lib/src/components/TaskRow/TaskRow.css"
      provides: "gantt-tr-lockIcon and gantt-tr-locked styles"
      contains: "gantt-tr-lockIcon"
  key_links:
    - from: "packages/gantt-lib/src/components/TaskRow/TaskRow.tsx"
      to: "packages/gantt-lib/src/hooks/useTaskDrag.ts"
      via: "locked: task.locked passed to useTaskDrag options"
      pattern: "locked.*task\\.locked"
    - from: "packages/gantt-lib/src/hooks/useTaskDrag.ts"
      to: "globalActiveDrag"
      via: "early return in handleMouseDown when locked === true"
      pattern: "if.*locked.*return"
---

<objective>
Add the `locked?: boolean` prop to the task type model and wire it through the hook and component layers so that locked tasks are completely immune to drag and resize interactions, and display a visual padlock icon.

Purpose: Locked tasks represent completed or fixed work that must not be rescheduled. This provides a per-task freeze mechanism independent of `accepted` or `progress`.
Output: Type extension in both Task interfaces, hook guard that prevents drag initiation, cursor feedback, lock icon in TaskRow, cascade-safe filtering.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-lock-task/11-CONTEXT.md
@.planning/phases/11-lock-task/11-RESEARCH.md
@packages/gantt-lib/src/types/index.ts
@packages/gantt-lib/src/components/GanttChart/GanttChart.tsx
@packages/gantt-lib/src/hooks/useTaskDrag.ts
@packages/gantt-lib/src/components/TaskRow/TaskRow.tsx
@packages/gantt-lib/src/components/TaskRow/TaskRow.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add locked field to both Task interfaces and hook options</name>
  <files>
    packages/gantt-lib/src/types/index.ts
    packages/gantt-lib/src/components/GanttChart/GanttChart.tsx
    packages/gantt-lib/src/hooks/useTaskDrag.ts
  </files>
  <action>
**1. packages/gantt-lib/src/types/index.ts** — Add `locked?: boolean` to the `Task` interface, after the `dependencies` field:

```typescript
/**
 * Optional flag to prevent drag and resize interactions.
 * When true, the task bar cannot be moved or resized.
 * Independent of accepted/progress — consumer controls both separately.
 */
locked?: boolean;
```

**2. packages/gantt-lib/src/components/GanttChart/GanttChart.tsx** — Add `locked?: boolean` to the internal `Task` interface (the one exported from GanttChart.tsx), after the `dependencies` field. Same JSDoc comment as above. Both interfaces must stay in sync — the library's public type export comes from types/index.ts, but consumers who import Task from GanttChart will see this one.

**3. packages/gantt-lib/src/hooks/useTaskDrag.ts** — Three changes:

a) Add `locked?: boolean` to `UseTaskDragOptions` interface, after `disableConstraints`:
```typescript
/** When true, all drag and resize interactions are disabled for this task */
locked?: boolean;
```

b) Destructure `locked = false` from `options` in the `useTaskDrag` function body (alongside the other destructured options).

c) In `handleMouseDown` useCallback: add an early return as the FIRST line of the callback body (before `detectEdgeZone`):
```typescript
if (locked) return;
```
Add `locked` to the `handleMouseDown` dependency array.

d) In `getCursorStyle` useCallback: update to return `'not-allowed'` when locked:
```typescript
const getCursorStyle = useCallback((): string => {
  if (locked) return 'not-allowed';
  if (isDragging) return 'grabbing';
  return 'grab';
}, [locked, isDragging]);
```

**5. packages/gantt-lib/src/hooks/useTaskDrag.ts — Cascade filtering for locked tasks:**

In `handleGlobalMouseMove`, inside the `for (const chainTask of activeChain)` loop (the one that builds `overrides`), add a `continue` guard as the first statement:
```typescript
if (chainTask.locked) continue; // Phase 11: locked tasks cannot be moved by cascade
```

This implements Option B from the research: skip locked tasks in the visual override map but continue traversal to their successors (the loop continues — it does not break the chain).

Also in `handleComplete` / `chainForCompletion` mapping: in the `.map(chainTask => ...)` inside `cascadedTasks`, add a filter before the map:
```typescript
...chainForCompletion
  .filter(chainTask => !chainTask.locked) // Phase 11: skip locked tasks in cascade
  .map(chainTask => { ... })
```
This prevents locked tasks from being included in the `onCascade` result with shifted dates.
  </action>
  <verify>
Run TypeScript build to confirm no type errors:
```bash
cd D:/Projects/gantt-lib && npm run build --workspace=packages/gantt-lib 2>&1 | tail -20
```
Expected: build succeeds with no errors. No `locked` type errors.
  </verify>
  <done>
- `locked?: boolean` exists in types/index.ts Task interface
- `locked?: boolean` exists in GanttChart.tsx Task interface
- `locked?: boolean` exists in UseTaskDragOptions
- `handleMouseDown` returns early when `locked === true` (verified by reading the function)
- `getCursorStyle` returns `'not-allowed'` when locked
- Cascade loop skips locked tasks via `if (chainTask.locked) continue`
- `chainForCompletion.filter(t => !t.locked)` applied before map
- TypeScript build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: TaskRow — pass locked to hook, render lock icon, update arePropsEqual, add CSS</name>
  <files>
    packages/gantt-lib/src/components/TaskRow/TaskRow.tsx
    packages/gantt-lib/src/components/TaskRow/TaskRow.css
  </files>
  <action>
**packages/gantt-lib/src/components/TaskRow/TaskRow.tsx** — Four changes:

**a) arePropsEqual** — Add `locked` check after the existing `disableConstraints` line:
```typescript
prevProps.task.locked === nextProps.task.locked
// onChange, onCascadeProgress, onCascade excluded - see note above
```

**b) useTaskDrag call** — Add `locked: task.locked` to the options object passed to `useTaskDrag` (alongside `disableConstraints`):
```typescript
locked: task.locked,
```

**c) Task bar className** — Update the `className` on the `gantt-tr-taskBar` div to include the locked modifier:
```tsx
className={`gantt-tr-taskBar ${isDragging ? 'gantt-tr-dragging' : ''} ${task.locked ? 'gantt-tr-locked' : ''}`}
```

**d) Lock icon in JSX** — Inside the `gantt-tr-taskBar` div, add the lock icon as the FIRST child (before the `gantt-tr-progressBar` div). Placement: between the opening div tag and the progress bar. The icon should only render when `task.locked === true`:

```tsx
{task.locked && (
  <svg
    className="gantt-tr-lockIcon"
    viewBox="0 0 24 24"
    fill="currentColor"
    aria-label="Locked"
    aria-hidden="false"
  >
    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
  </svg>
)}
```

The icon uses `fill="currentColor"` so it inherits the task bar's `--gantt-task-bar-text-color` CSS variable. It renders BEFORE the resize handle left and the task duration span, so it is positioned at the far left of the bar content area.

**packages/gantt-lib/src/components/TaskRow/TaskRow.css** — Add two new rule blocks at the end of the file:

```css
/* Lock icon inside task bar */
.gantt-tr-lockIcon {
  width: 12px;
  height: 12px;
  margin-right: 4px;
  flex-shrink: 0;
  opacity: 0.85;
  position: relative;
  z-index: 2; /* same stacking level as gantt-tr-taskDuration, above progress bar */
  color: var(--gantt-task-bar-text-color);
}

/* Locked task bar state — consumer CSS override point */
.gantt-tr-taskBar.gantt-tr-locked {
  cursor: not-allowed;
}
```

Note: cursor is also set inline via `dragHandleProps.style.cursor` (from `getCursorStyle`). The CSS class is an additional override point for consumers (DX-05 pattern).
  </action>
  <verify>
Run TypeScript build:
```bash
cd D:/Projects/gantt-lib && npm run build --workspace=packages/gantt-lib 2>&1 | tail -20
```
Then confirm by reading TaskRow.tsx that:
1. `arePropsEqual` includes `prevProps.task.locked === nextProps.task.locked`
2. `useTaskDrag` call includes `locked: task.locked`
3. JSX contains `{task.locked && (<svg className="gantt-tr-lockIcon" ...`
4. `gantt-tr-taskBar` className includes `task.locked ? 'gantt-tr-locked' : ''`
  </verify>
  <done>
- arePropsEqual checks task.locked
- useTaskDrag receives locked: task.locked
- Lock SVG icon renders conditionally before duration text
- taskBar className includes gantt-tr-locked modifier when locked
- CSS defines gantt-tr-lockIcon (12x12, z-index 2, flex-shrink 0) and gantt-tr-locked modifier
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript build passes: `npm run build --workspace=packages/gantt-lib`
2. Read `packages/gantt-lib/src/types/index.ts` — confirm `locked?: boolean` exists in Task interface
3. Read `packages/gantt-lib/src/components/GanttChart/GanttChart.tsx` — confirm `locked?: boolean` in internal Task interface
4. Read `packages/gantt-lib/src/hooks/useTaskDrag.ts` — confirm `if (locked) return;` at top of handleMouseDown body, `getCursorStyle` returns 'not-allowed', cascade loop has `if (chainTask.locked) continue`
5. Read `packages/gantt-lib/src/components/TaskRow/TaskRow.tsx` — confirm arePropsEqual, locked prop passing, SVG icon conditional render
6. Read `packages/gantt-lib/src/components/TaskRow/TaskRow.css` — confirm gantt-tr-lockIcon and gantt-tr-locked rules exist
</verification>

<success_criteria>
- Both Task interface duplicates have `locked?: boolean`
- useTaskDrag early-returns for locked tasks — no drag state is ever set for locked tasks
- getCursorStyle returns 'not-allowed' when locked (flows to dragHandleProps.style.cursor in TaskRow)
- Lock SVG icon (Material Design padlock path) renders conditionally in task bar JSX for locked tasks
- arePropsEqual includes locked check — locked state changes trigger re-render
- Cascade chain emits no overrides for locked tasks (visual freeze during predecessor drag)
- Locked tasks excluded from chainForCompletion result — dates unchanged in onCascade output
- TypeScript build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-lock-task/11-01-SUMMARY.md` with:
- What was implemented (type changes, hook guard locations, cascade filter locations, JSX structure)
- Exact line changes and patterns used
- Any deviations from the plan
- Build verification result
</output>
