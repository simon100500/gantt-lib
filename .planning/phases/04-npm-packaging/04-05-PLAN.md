---
phase: 04-npm-packaging
plan: 05
type: execute
wave: 4
depends_on: ["04-03", "04-04"]
files_modified:
  - package-lock.json
autonomous: false
requirements: [DX-01, DX-02, DX-03, DX-04]

must_haves:
  truths:
    - "npm install from root resolves workspace packages without errors"
    - "turbo build successfully builds packages/gantt-lib producing dist/ artifacts"
    - "dist/index.js (CJS) exists and starts with 'use client'"
    - "dist/index.mjs (ESM) exists and starts with 'use client'"
    - "dist/index.d.ts exists and exports GanttChart, Task, GanttChartProps and other types"
    - "dist/styles.css exists (renamed from tsup emitted CSS)"
    - "gzip size of dist/index.mjs is under 15KB"
    - "packages/website dev server starts without errors"
  artifacts:
    - path: "packages/gantt-lib/dist/index.js"
      provides: "CJS bundle with use client directive"
      contains: "'use client'"
    - path: "packages/gantt-lib/dist/index.mjs"
      provides: "ESM bundle with use client directive"
      contains: "'use client'"
    - path: "packages/gantt-lib/dist/index.d.ts"
      provides: "TypeScript declarations"
      contains: "GanttChart"
    - path: "packages/gantt-lib/dist/styles.css"
      provides: "Aggregated CSS for consumers"
  key_links:
    - from: "packages/website/src/app/page.tsx"
      to: "packages/gantt-lib/dist/index.mjs"
      via: "npm workspace resolution gantt-lib -> dist"
      pattern: "from 'gantt-lib'"
    - from: "packages/website/src/app/layout.tsx"
      to: "packages/gantt-lib/dist/styles.css"
      via: "gantt-lib/styles.css subpath export"
      pattern: "import 'gantt-lib/styles.css'"
---

<objective>
Install all workspace dependencies from root, build the library with turbo, verify all dist artifacts meet requirements (use client directive, bundle size < 15KB gzipped, declarations present, styles.css renamed), then verify the website dev server starts.

Purpose: End-to-end validation that the monorepo build pipeline works and all requirements are met.
Output: packages/gantt-lib/dist/ with CJS, ESM, declarations, and CSS. Website running against workspace library.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-npm-packaging/04-CONTEXT.md
@.planning/phases/04-npm-packaging/04-RESEARCH.md
@.planning/phases/04-npm-packaging/04-04-SUMMARY.md
@.planning/phases/04-npm-packaging/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: npm install from root and build library with turbo</name>
  <files>package-lock.json</files>
  <action>
    Run all commands from repo root `D:/Projects/gantt-lib`.

    CRITICAL per RESEARCH.md: Always run npm install from root only. Never run npm install inside sub-packages.

    Step 1 — Install all workspace dependencies:
    ```bash
    npm install
    ```
    This resolves the `packages/*` workspaces, installs turbo, tsup, esbuild-plugin-preserve-directives, etc. into root node_modules with symlinks for workspace packages. Expect gantt-lib to be symlinked at `node_modules/gantt-lib -> ../packages/gantt-lib`.

    If npm install fails with errors about missing packages, diagnose:
    - If turbo is missing: `npm install turbo --save-dev` then re-run
    - If esbuild-plugin-preserve-directives errors: check package name is exact in packages/gantt-lib/package.json devDeps

    Step 2 — Build the library:
    ```bash
    npx turbo build --filter=gantt-lib
    ```
    This runs `tsup` in packages/gantt-lib. Expected output:
    - `packages/gantt-lib/dist/index.js` (CJS)
    - `packages/gantt-lib/dist/index.mjs` (ESM)
    - `packages/gantt-lib/dist/index.d.ts` (declarations)
    - `packages/gantt-lib/dist/styles.css` (renamed via onSuccess)

    If tsup build fails, common issues and fixes:
    - "Cannot find module 'esbuild-plugin-preserve-directives'" → check devDeps in packages/gantt-lib/package.json, re-run npm install
    - CSS import error → verify packages/gantt-lib/src/styles.css exists and uses @import syntax
    - Type errors → run `npx tsc --noEmit` in packages/gantt-lib to get full diagnostics

    Step 3 — Verify dist artifacts:
    ```bash
    ls packages/gantt-lib/dist/
    # Should show: index.js  index.js.map  index.mjs  index.mjs.map  index.d.ts  styles.css

    head -1 packages/gantt-lib/dist/index.js
    # Should show: 'use client';  OR  "use client";

    head -1 packages/gantt-lib/dist/index.mjs
    # Should show: 'use client';

    # Check gzip size of ESM bundle (DX-03: < 15KB gzipped)
    gzip -c packages/gantt-lib/dist/index.mjs | wc -c
    # Must be under 15360 bytes (15KB)
    ```

    Step 4 — Run library tests to confirm nothing broke:
    ```bash
    npx turbo test --filter=gantt-lib
    ```
    All 3 test files (dateUtils, geometry, useTaskDrag) must pass. If test imports fail due to path changes from the migration, fix the import paths in the test files — they should use relative imports within packages/gantt-lib/src/.

    Step 5 — Verify TypeScript declarations:
    ```bash
    grep "GanttChart" packages/gantt-lib/dist/index.d.ts
    grep "Task" packages/gantt-lib/dist/index.d.ts
    grep "GanttChartProps" packages/gantt-lib/dist/index.d.ts
    ```
    All three must return results.
  </action>
  <verify>
    1. `ls packages/gantt-lib/dist/` shows index.js, index.mjs, index.d.ts, styles.css
    2. `head -1 packages/gantt-lib/dist/index.js` starts with 'use client'
    3. `head -1 packages/gantt-lib/dist/index.mjs` starts with 'use client'
    4. `gzip -c packages/gantt-lib/dist/index.mjs | wc -c` returns a number under 15360
    5. `cat packages/gantt-lib/dist/styles.css` contains CSS rules (non-empty)
    6. All turbo test passes for gantt-lib filter
  </verify>
  <done>dist/ artifacts all present. CJS and ESM bundles start with 'use client'. ESM bundle under 15KB gzipped. TypeScript declarations exported. styles.css non-empty. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — demo page renders and interactions work</name>
  <what-built>
    Complete monorepo build pipeline:
    - Root workspaces (packages/gantt-lib, packages/website)
    - Library built to dist/ with CJS + ESM + declarations + styles.css
    - Website app wired to workspace gantt-lib
    - All source moved via git mv (history preserved)
    - CSS Modules converted to plain CSS with namespaced class names
  </what-built>
  <how-to-verify>
    1. Build the website and start dev server:
       ```bash
       npx turbo build --filter=gantt-lib && npx turbo dev --filter=website
       ```
       or from root: `npm run dev` (turbo will build gantt-lib first, then start website)

    2. Open http://localhost:3000 in a browser.

    3. Verify the demo page shows:
       - A Gantt chart with task bars visible on a calendar grid
       - Two-row header (month names on top, day numbers below)
       - Weekend columns highlighted in pink
       - Today indicator vertical line (if today is in the task date range)

    4. Test interactivity:
       - Drag a task bar horizontally — it should move and update its position
       - Drag a task bar edge — it should resize

    5. Check no console errors in DevTools (F12).

    6. Verify CSS is loading from the library (not from old Next.js globals):
       - Inspect a task bar element in DevTools
       - Its classes should have prefixed names like `gantt-tr-taskBar`, `gantt-gb-gridBackground`, etc. (not hashed CSS Modules names)
  </how-to-verify>
  <action>Start the website dev server: `npx turbo dev --filter=website` (or `npm run dev` from root). Then open http://localhost:3000 and follow the verification steps below.</action>
  <verify>
    Follow all steps in how-to-verify above. Confirm task bars render, drag/resize works, and no console errors appear.
  </verify>
  <done>Demo page at http://localhost:3000 shows a working Gantt chart with draggable tasks. No console errors. User types "approved".</done>
  <resume-signal>Type "approved" if the demo page works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Post-checkpoint final checks:
1. `ls packages/gantt-lib/dist/` — confirms all 4+ artifact files exist
2. `gzip -c packages/gantt-lib/dist/index.mjs | wc -c` — confirms < 15360 bytes (DX-03)
3. `grep -c "export" packages/gantt-lib/dist/index.d.ts` — confirms declarations non-trivial
4. `node -e "const lib = require('./packages/gantt-lib/dist/index.js'); console.log(Object.keys(lib))"` — should list GanttChart, TaskRow, etc.
</verification>

<success_criteria>
- npm install completes without errors from root
- turbo build produces all dist/ artifacts
- dist/index.js and dist/index.mjs both start with 'use client'
- dist/styles.css is non-empty
- dist/index.d.ts exports GanttChart, Task, GanttChartProps
- ESM bundle gzip size is under 15KB (DX-03)
- All library tests pass
- Website demo page renders correctly at http://localhost:3000 (human verified)
</success_criteria>

<output>
After completion, create `.planning/phases/04-npm-packaging/04-05-SUMMARY.md`
</output>
