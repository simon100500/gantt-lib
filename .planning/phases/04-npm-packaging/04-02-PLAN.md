---
phase: 04-npm-packaging
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/gantt-lib/package.json
  - packages/gantt-lib/tsup.config.ts
  - packages/gantt-lib/tsconfig.json
  - packages/gantt-lib/vitest.config.ts
autonomous: true
requirements: [DX-01, DX-02, DX-03, DX-04]

must_haves:
  truths:
    - "packages/gantt-lib/package.json declares name gantt-lib version 0.0.1 with correct exports field"
    - "packages/gantt-lib/package.json lists react and react-dom as peerDependencies >=18"
    - "packages/gantt-lib/package.json lists date-fns in dependencies (auto-installed)"
    - "tsup.config.ts uses esbuild-plugin-preserve-directives to handle use client directive in CJS output"
    - "tsup.config.ts onSuccess renames the emitted CSS file to dist/styles.css"
    - "packages/gantt-lib/tsconfig.json extends root tsconfig.json and adds dts: true compatible settings"
  artifacts:
    - path: "packages/gantt-lib/package.json"
      provides: "Library npm manifest with exports field"
      contains: '"exports"'
    - path: "packages/gantt-lib/tsup.config.ts"
      provides: "tsup build configuration with preserve-directives plugin"
      contains: "esbuild-plugin-preserve-directives"
    - path: "packages/gantt-lib/tsconfig.json"
      provides: "Library TypeScript config extending root base"
      contains: '"extends": "../../tsconfig.json"'
    - path: "packages/gantt-lib/vitest.config.ts"
      provides: "Vitest test runner config for library"
      contains: "defineConfig"
  key_links:
    - from: "packages/gantt-lib/tsup.config.ts"
      to: "packages/gantt-lib/dist/styles.css"
      via: "onSuccess CSS rename"
      pattern: "onSuccess.*styles\\.css"
    - from: "packages/gantt-lib/package.json"
      to: "packages/gantt-lib/dist/index.mjs"
      via: "exports.import field"
      pattern: '"import".*dist/index\.mjs'
---

<objective>
Create the `packages/gantt-lib/` directory and all its config files: package.json (library manifest with exports), tsup.config.ts (dual CJS+ESM build with CSS), tsconfig.json (extends root), and vitest.config.ts.

Purpose: Library package config layer that the source migration plan (04-03) will populate with actual source files.
Output: packages/gantt-lib/ directory with four config files ready for source files.
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-npm-packaging/04-CONTEXT.md
@.planning/phases/04-npm-packaging/04-RESEARCH.md
@.planning/phases/04-npm-packaging/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packages/gantt-lib/package.json with exports field</name>
  <files>packages/gantt-lib/package.json</files>
  <action>
    Create the `packages/gantt-lib/` directory and write `packages/gantt-lib/package.json`:

    ```json
    {
      "name": "gantt-lib",
      "version": "0.0.1",
      "description": "Lightweight React Gantt chart component library",
      "license": "MIT",
      "main": "./dist/index.js",
      "module": "./dist/index.mjs",
      "types": "./dist/index.d.ts",
      "exports": {
        ".": {
          "import": "./dist/index.mjs",
          "require": "./dist/index.js",
          "types": "./dist/index.d.ts"
        },
        "./styles.css": "./dist/styles.css"
      },
      "files": ["dist"],
      "scripts": {
        "build": "tsup",
        "dev": "tsup --watch",
        "test": "vitest run",
        "lint": "eslint src"
      },
      "peerDependencies": {
        "react": ">=18",
        "react-dom": ">=18"
      },
      "dependencies": {
        "date-fns": "^4.1.0"
      },
      "devDependencies": {
        "@types/react": "^19.0.0",
        "@types/react-dom": "^19.0.0",
        "@vitejs/plugin-react": "^4.3.0",
        "@vitest/coverage-v8": "^3.2.4",
        "@testing-library/react": "^16.3.2",
        "@testing-library/jest-dom": "^6.9.1",
        "esbuild-plugin-preserve-directives": "^0.0.6",
        "jsdom": "^25.0.0",
        "react": "^19.0.0",
        "react-dom": "^19.0.0",
        "tsup": "^8.0.0",
        "typescript": "^5.7.0",
        "vitest": "^3.0.0"
      }
    }
    ```

    Key decisions from CONTEXT.md:
    - `clsx` is bundled into dist via tsup (NOT a dep or peerDep — consumers do not install it)
    - `date-fns` is in `dependencies` (auto-installed for consumers)
    - `react` and `react-dom` are `peerDependencies` (>=18, supports React 18 and 19)
    - Package name is exactly `gantt-lib`
  </action>
  <verify>
    Read packages/gantt-lib/package.json and confirm:
    - `"name": "gantt-lib"` and `"version": "0.0.1"`
    - `"exports"` field contains both `.` entry and `"./styles.css"` entry
    - `"peerDependencies"` contains react and react-dom with `>=18`
    - `"dependencies"` contains date-fns but NOT clsx (clsx is bundled)
    - `"devDependencies"` contains `esbuild-plugin-preserve-directives`
  </verify>
  <done>packages/gantt-lib/package.json exists with correct exports field, peerDeps, and deps. clsx is absent from all dep fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create tsup.config.ts, tsconfig.json, and vitest.config.ts</name>
  <files>packages/gantt-lib/tsup.config.ts, packages/gantt-lib/tsconfig.json, packages/gantt-lib/vitest.config.ts</files>
  <action>
    1. Create `packages/gantt-lib/tsup.config.ts` — use the exact pattern from RESEARCH.md to handle `"use client"` in CJS correctly:

    ```typescript
    import { defineConfig } from 'tsup';
    import preserveDirectives from 'esbuild-plugin-preserve-directives';

    export default defineConfig({
      entry: ['src/index.ts'],
      format: ['cjs', 'esm'],
      dts: true,
      splitting: false,
      clean: true,
      sourcemap: true,
      external: ['react', 'react-dom', 'date-fns'],
      esbuildPlugins: [
        preserveDirectives({
          directives: ['use client', 'use strict'],
          include: /\.(js|ts|jsx|tsx)$/,
        }),
      ],
      onSuccess: async () => {
        const fs = await import('fs');
        const path = await import('path');
        const distDir = path.join(process.cwd(), 'dist');
        const cssFiles = fs.readdirSync(distDir).filter((f: string) => f.endsWith('.css') && f !== 'styles.css');
        if (cssFiles.length > 0) {
          fs.renameSync(path.join(distDir, cssFiles[0]), path.join(distDir, 'styles.css'));
        }
      },
    });
    ```

    CRITICAL: The `banner` option must NOT be used for `"use client"` — it breaks CJS because `"use strict"` is injected before it. The `esbuild-plugin-preserve-directives` is the correct solution per RESEARCH.md.

    `clsx` is NOT in the `external` array — it will be bundled into dist.

    2. Create `packages/gantt-lib/tsconfig.json`:
    ```json
    {
      "extends": "../../tsconfig.json",
      "compilerOptions": {
        "jsx": "react-jsx",
        "declaration": true,
        "declarationDir": "dist",
        "outDir": "dist",
        "rootDir": "src"
      },
      "include": ["src/**/*.ts", "src/**/*.tsx"],
      "exclude": ["node_modules", "dist"]
    }
    ```

    3. Create `packages/gantt-lib/vitest.config.ts` — adapted from existing root vitest.config.ts but scoped to packages/gantt-lib:
    ```typescript
    import { defineConfig } from 'vitest/config';
    import react from '@vitejs/plugin-react';

    export default defineConfig({
      plugins: [react()],
      test: {
        globals: true,
        environment: 'jsdom',
        setupFiles: [],
        include: ['src/**/__tests__/**/*.ts', 'src/**/__tests__/**/*.tsx'],
        exclude: ['node_modules', 'dist'],
        coverage: {
          provider: 'v8',
          reporter: ['text', 'json', 'html'],
          exclude: [
            'node_modules/',
            'dist/',
            '**/*.d.ts',
            '**/*.config.*',
          ],
        },
      },
    });
    ```
  </action>
  <verify>
    1. Read packages/gantt-lib/tsup.config.ts — confirm `esbuild-plugin-preserve-directives` is imported and used in `esbuildPlugins`, `onSuccess` contains `styles.css` rename logic, `clsx` is NOT in `external`.
    2. Read packages/gantt-lib/tsconfig.json — confirm `"extends": "../../tsconfig.json"` and `"declaration": true`.
    3. Read packages/gantt-lib/vitest.config.ts — confirm jsdom environment and correct include pattern.
  </verify>
  <done>All three config files exist. tsup config correctly uses preserve-directives plugin for use-client handling. tsconfig extends root base. vitest scoped to packages/gantt-lib/src.</done>
</task>

</tasks>

<verification>
From repo root:
1. `ls packages/gantt-lib/` — shows package.json, tsup.config.ts, tsconfig.json, vitest.config.ts
2. Spot-check exports field: `node -e "const p=require('./packages/gantt-lib/package.json'); console.log(JSON.stringify(p.exports, null, 2))"`
3. Confirm no src/ directory yet in packages/gantt-lib/ (source migration is plan 04-04)
</verification>

<success_criteria>
packages/gantt-lib/ directory exists with four correctly configured files. The tsup config is ready to build dual CJS+ESM output with CSS and preserve-directives plugin. The package.json exports field matches the spec from CONTEXT.md exactly.
</success_criteria>

<output>
After completion, create `.planning/phases/04-npm-packaging/04-02-SUMMARY.md`
</output>
