---
phase: 06-dependencies
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/gantt-lib/src/components/DependencyLines/DependencyLines.tsx
  - packages/gantt-lib/src/components/DependencyLines/DependencyLines.css
  - packages/gantt-lib/src/components/DependencyLines/index.tsx
  - packages/gantt-lib/src/components/index.ts
  - packages/gantt-lib/src/styles.css
autonomous: true
requirements: [REND-08]

must_haves:
  truths:
    - "Dependency lines are rendered as SVG overlay on Gantt chart"
    - "Lines use Bezier curves connecting predecessor end to successor start"
    - "Arrow markers appear at line endpoints"
    - "Circular dependencies are highlighted in red"
    - "SVG layer handles horizontal scrolling with grid content"
    - "Component uses React.memo to prevent unnecessary re-renders"
  artifacts:
    - path: "packages/gantt-lib/src/components/DependencyLines/DependencyLines.tsx"
      provides: "SVG-based dependency lines rendering component"
      exports: ["DependencyLines"]
      min_lines: 80
    - path: "packages/gantt-lib/src/components/DependencyLines/DependencyLines.css"
      provides: "SVG overlay styling with z-index and pointer-events"
      contains: "gantt-dependencies-svg, gantt-dependency-path"
      min_lines: 20
    - path: "packages/gantt-lib/src/components/DependencyLines/index.tsx"
      provides: "DependencyLines component export"
    - path: "packages/gantt-lib/src/styles.css"
      provides: "CSS variables for dependency line colors"
      contains: "--gantt-dependency-line-color, --gantt-dependency-cycle-color"
  key_links:
    - from: "DependencyLines.tsx"
      to: "Task type"
      via: "Imported for dependency definitions"
      pattern: "import.*Task.*from.*types"
    - from: "DependencyLines.tsx"
      to: "calculateBezierPath"
      via: "Imported from utils/geometry for path calculation"
      pattern: "import.*calculateBezierPath.*from.*geometry"
    - from: "DependencyLines.tsx"
      to: "detectCycles"
      via: "Imported from utils/dependencyUtils for cycle detection"
      pattern: "import.*detectCycles.*from.*dependencyUtils"
    - from: "DependencyLines.css"
      to: "styles.css"
      via: "Uses CSS variables for line colors"
      pattern: "var\\(--gantt-dependency-"
---

<objective>
Create SVG-based DependencyLines component that renders Bezier curve arrows between dependent tasks with cycle detection visualization.

**Purpose:** Visualize task dependencies as curved arrow lines connecting predecessor tasks to their successors, with special highlighting for circular dependencies.

**Output:**
- React component rendering SVG overlay with Bezier curve paths
- Arrow marker definition for line endpoints
- CSS styling for neutral (gray) and cycle (red) line colors
- React.memo optimization to prevent re-renders of unrelated lines
- Integration with task positioning system for accurate line coordinates
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-dependencies/06-CONTEXT.md
@.planning/phases/06-dependencies/06-RESEARCH.md

# Prior plan - types and utilities
@.planning/phases/06-dependencies/06-01-PLAN.md

# Codebase patterns for components and styling
@.planning/phases/01-foundation-core-rendering/01-03-SUMMARY.md
@.planning/phases/03-calendar/03-04-SUMMARY.md
@packages/gantt-lib/src/components/GridBackground/GridBackground.tsx
@packages/gantt-lib/src/components/TodayIndicator/TodayIndicator.tsx
@packages/gantt-lib/src/components/GanttChart/GanttChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DependencyLines component with SVG overlay</name>
  <files>packages/gantt-lib/src/components/DependencyLines/DependencyLines.tsx,packages/gantt-lib/src/components/DependencyLines/DependencyLines.css,packages/gantt-lib/src/components/DependencyLines/index.tsx</files>
  <action>
Create three files for the DependencyLines component:

**1. packages/gantt-lib/src/components/DependencyLines/DependencyLines.tsx:**

```typescript
'use client';

import React, { useMemo } from 'react';
import { Task } from '../../types';
import { calculateTaskBar } from '../../utils/geometry';
import { calculateBezierPath } from '../../utils/geometry';
import { getAllDependencyEdges, detectCycles } from '../../utils/dependencyUtils';
import './DependencyLines.css';

export interface DependencyLinesProps {
  /** All tasks in the chart */
  tasks: Task[];
  /** Start of the visible range (e.g., month start) */
  monthStart: Date;
  /** Width of each day column in pixels */
  dayWidth: number;
  /** Height of each task row in pixels */
  rowHeight: number;
  /** Total width of the grid in pixels */
  gridWidth: number;
}

/**
 * SVG overlay component rendering dependency lines as Bezier curves
 *
 * Lines connect from the right edge of predecessor tasks to the left edge
 * of successor tasks. Circular dependencies are highlighted in red.
 *
 * Performance: Uses React.memo to prevent re-renders when dependencies haven't changed.
 */
export const DependencyLines: React.FC<DependencyLinesProps> = React.memo(({
  tasks,
  monthStart,
  dayWidth,
  rowHeight,
  gridWidth,
}) => {
  // Create a lookup map for task positions
  const taskPositions = useMemo(() => {
    const positions = new Map<string, { left: number; right: number; centerY: number; index: number }>();

    tasks.forEach((task, index) => {
      const startDate = new Date(task.startDate);
      const endDate = new Date(task.endDate);
      const { left, width } = calculateTaskBar(startDate, endDate, monthStart, dayWidth);

      positions.set(task.id, {
        left,
        right: left + width,
        centerY: index * rowHeight + rowHeight / 2,
        index,
      });
    });

    return positions;
  }, [tasks, monthStart, dayWidth, rowHeight]);

  // Detect cycles for highlighting
  const cycleInfo = useMemo(() => {
    const result = detectCycles(tasks);
    const cycleTaskIds = new Set(result.cyclePath || []);
    return cycleTaskIds;
  }, [tasks]);

  // Calculate all dependency line paths
  const lines = useMemo(() => {
    const edges = getAllDependencyEdges(tasks);
    const lines: Array<{
      id: string;
      path: string;
      hasCycle: boolean;
    }> = [];

    for (const edge of edges) {
      const predecessor = taskPositions.get(edge.predecessorId);
      const successor = taskPositions.get(edge.successorId);

      if (!predecessor || !successor) {
        continue; // Skip if task not found (shouldn't happen with validation)
      }

      // Line starts from right edge of predecessor, ends at left edge of successor
      const from = { x: predecessor.right, y: predecessor.centerY };
      const to = { x: successor.left, y: successor.centerY };

      const path = calculateBezierPath(from, to);

      // Check if this edge is part of a cycle
      const hasCycle = cycleInfo.has(edge.predecessorId) || cycleInfo.has(edge.successorId);

      lines.push({
        id: `${edge.predecessorId}-${edge.successorId}`,
        path,
        hasCycle,
      });
    }

    return lines;
  }, [tasks, taskPositions, cycleInfo]);

  return (
    <svg
      className="gantt-dependencies-svg"
      width={gridWidth}
      height={tasks.length * rowHeight}
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        {/* Arrow marker for dependency lines */}
        <marker
          id="arrowhead"
          className="gantt-dependency-arrow"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon points="0 0, 10 3.5, 0 7" />
        </marker>

        {/* Red arrow marker for circular dependencies */}
        <marker
          id="arrowhead-cycle"
          className="gantt-dependency-arrow gantt-dependency-arrow-cycle"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon points="0 0, 10 3.5, 0 7" />
        </marker>
      </defs>

      {lines.map(({ id, path, hasCycle }) => (
        <path
          key={id}
          d={path}
          className={hasCycle ? 'gantt-dependency-path gantt-dependency-cycle' : 'gantt-dependency-path'}
          markerEnd={hasCycle ? 'url(#arrowhead-cycle)' : 'url(#arrowhead)'}
        />
      ))}
    </svg>
  );
});

DependencyLines.displayName = 'DependencyLines';

export default DependencyLines;
```

**2. packages/gantt-lib/src/components/DependencyLines/DependencyLines.css:**

```css
/* SVG overlay for dependency lines */
.gantt-dependencies-svg {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 5;
  pointer-events: none; /* Allow clicks to pass through to task bars */
  overflow: visible;
}

/* Dependency line path */
.gantt-dependency-path {
  fill: none;
  stroke: var(--gantt-dependency-line-color, #666666);
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Circular dependency highlighting */
.gantt-dependency-cycle {
  stroke: var(--gantt-dependency-cycle-color, #ef4444);
}

/* Arrow markers */
.gantt-dependency-arrow polygon {
  fill: var(--gantt-dependency-line-color, #666666);
}

.gantt-dependency-arrow-cycle polygon {
  fill: var(--gantt-dependency-cycle-color, #ef4444);
}
```

**3. packages/gantt-lib/src/components/DependencyLines/index.tsx:**

```typescript
export { default as DependencyLines } from './DependencyLines';
export type { DependencyLinesProps } from './DependencyLines';
```

**Key patterns:**
- Use 'use client' directive for client component (following existing components)
- React.memo with custom comparison would prevent re-renders (default comparison fine for primitive props)
- useMemo for expensive calculations (following GridBackground pattern)
- CSS Variables for theming (following GanttChart.css pattern)
- Absolute positioning for SVG overlay (following TodayIndicator pattern)
- pointer-events: none to avoid blocking task interactions
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/gantt-lib to verify no TypeScript errors.
  </verify>
  <done>
DependencyLines component exists with SVG overlay rendering, CSS styles define line colors with CSS variables, and TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export DependencyLines from components and add CSS variables to styles.css</name>
  <files>packages/gantt-lib/src/components/index.ts,packages/gantt-lib/src/styles.css</files>
  <action>
Update two files:

**1. packages/gantt-lib/src/components/index.ts:**
Add the DependencyLines export (maintain alphabetical order):

```typescript
export { DependencyLines } from './DependencyLines';
```

**2. packages/gantt-lib/src/styles.css:**
Add CSS variables for dependency line colors (after existing --gantt-* variables):

```css
/* Dependency line colors */
--gantt-dependency-line-color: #666666;
--gantt-dependency-cycle-color: #ef4444;
```

**Important:** Maintain existing structure and only add new variables.
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/gantt-lib to verify no errors.
  </verify>
  <done>
DependencyLines is exported from components/index.ts, CSS variables for dependency colors are defined in styles.css, and TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. TypeScript compiles without errors: `npx tsc --noEmit` from packages/gantt-lib
2. All existing tests pass: `npm test`
3. DependencyLines can be imported: `import { DependencyLines } from 'gantt-lib/components'`
4. CSS variables are defined for dependency line colors
</verification>

<success_criteria>
1. DependencyLines component renders SVG overlay with Bezier curve paths
2. Arrow markers appear at line endpoints
3. Circular dependencies are highlighted in red color
4. SVG layer has pointer-events: none to avoid blocking interactions
5. React.memo prevents unnecessary re-renders
6. CSS variables allow customization of line colors
7. Component is exported from gantt-lib package
8. Zero breaking changes to existing API
</success_criteria>

<output>
After completion, create `.planning/phases/06-dependencies/06-02-SUMMARY.md`
</output>
