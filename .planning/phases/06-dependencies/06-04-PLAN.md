---
phase: 06-dependencies
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - packages/website/src/app/page.tsx
  - packages/gantt-lib/src/__tests__/dependencyUtils.test.ts
autonomous: false
requirements: [QL-03]

must_haves:
  truths:
    - "Demo page shows tasks with dependencies demonstrating all 4 link types"
    - "Dependency lines are visible between tasks"
    - "Circular dependency example is shown with red highlighting"
    - "Moving a task validates against its dependencies"
    - "Unit tests cover cycle detection, validation, and date calculations"
    - "Tests verify all four link types (FS, SS, FF, SF) with positive and negative lag"
  artifacts:
    - path: "packages/website/src/app/page.tsx"
      provides: "Demo page with dependency examples"
      contains: "dependencies, TaskDependency"
      min_lines: 50
    - path: "packages/gantt-lib/src/__tests__/dependencyUtils.test.ts"
      provides: "Unit tests for dependency utilities"
      contains: "describe.*dependencyUtils|it.*detectCycles|it.*calculateSuccessorDate"
      min_lines: 100
  key_links:
    - from: "page.tsx"
      to: "Task type"
      via: "Demo uses Task interface with dependencies property"
      pattern: "dependencies\\s*:\\s*\\["
    - from: "page.tsx"
      to: "DependencyLines"
      via: "Demo renders GanttChart which includes DependencyLines"
      pattern: "<GanttChart"
    - from: "dependencyUtils.test.ts"
      to: "dependencyUtils.ts"
      via: "Tests import and verify all exported functions"
      pattern: "import.*from.*dependencyUtils"
---

<objective>
Create demo page showcasing task dependencies with all link types and add comprehensive unit tests for dependency utilities.

**Purpose:** Demonstrate dependency functionality with real-world examples and ensure reliability through comprehensive unit tests covering cycle detection, link type calculations, and validation.

**Output:**
- Demo page with tasks showing all four link types (FS, SS, FF, SF)
- Circular dependency example with red highlighting
- Unit tests for cycle detection (DFS algorithm)
- Unit tests for calculateSuccessorDate with all link types and lag values
- Unit tests for validateDependencies with missing tasks and cycles
- Unit tests for getAllDependencyEdges
</objective>

<execution_context>
@C:/Users/Volobuev/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Volobuev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-dependencies/06-CONTEXT.md
@.planning/phases/06-dependencies/06-RESEARCH.md

# Prior plans - code to test and demonstrate
@.planning/phases/06-dependencies/06-01-PLAN.md
@.planning/phases/06-dependencies/06-02-PLAN.md

# Test patterns from codebase
@.planning/phases/01-foundation-core-rendering/01-02-SUMMARY.md
@.planning/phases/02-drag-and-drop-interactions/02-03-SUMMARY.md
@packages/gantt-lib/src/__tests__/dateUtils.test.ts
@packages/gantt-lib/src/__tests__/geometry.test.ts
@packages/website/src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for dependency utilities</name>
  <files>packages/gantt-lib/src/__tests__/dependencyUtils.test.ts</files>
  <action>
Create packages/gantt-lib/src/__tests__/dependencyUtils.test.ts with comprehensive tests:

```typescript
import { describe, it, expect } from 'vitest';
import {
  buildAdjacencyList,
  detectCycles,
  calculateSuccessorDate,
  validateDependencies,
  getAllDependencyEdges,
} from '../utils/dependencyUtils';
import { Task } from '../types';

describe('dependencyUtils', () => {
  const createTask = (id: string, start: string, end: string, deps?: any[]): Task => ({
    id,
    name: `Task ${id}`,
    startDate: start,
    endDate: end,
    dependencies: deps,
  });

  describe('buildAdjacencyList', () => {
    it('should build empty adjacency list for no tasks', () => {
      const result = buildAdjacencyList([]);
      expect(result.size).toBe(0);
    });

    it('should build adjacency list with no dependencies', () => {
      const tasks = [createTask('1', '2026-01-01', '2026-01-05')];
      const result = buildAdjacencyList(tasks);
      expect(result.get('1')).toEqual([]);
    });

    it('should build adjacency list with dependencies', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
        createTask('3', '2026-01-11', '2026-01-15', [{ taskId: '1', type: 'SS' }]),
      ];
      const result = buildAdjacencyList(tasks);
      expect(result.get('1')).toEqual(['2', '3']);
      expect(result.get('2')).toEqual([]);
      expect(result.get('3')).toEqual([]);
    });
  });

  describe('detectCycles', () => {
    it('should detect no cycles in independent tasks', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10'),
        createTask('3', '2026-01-11', '2026-01-15'),
      ];
      const result = detectCycles(tasks);
      expect(result.hasCycle).toBe(false);
      expect(result.cyclePath).toBeUndefined();
    });

    it('should detect no cycles in valid dependency chain', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
        createTask('3', '2026-01-11', '2026-01-15', [{ taskId: '2', type: 'FS' }]),
      ];
      const result = detectCycles(tasks);
      expect(result.hasCycle).toBe(false);
    });

    it('should detect direct cycle (A -> B -> A)', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05', [{ taskId: '2', type: 'FS' }]),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
      ];
      const result = detectCycles(tasks);
      expect(result.hasCycle).toBe(true);
      expect(result.cyclePath).toBeDefined();
      expect(result.cyclePath?.length).toBeGreaterThan(0);
    });

    it('should detect indirect cycle (A -> B -> C -> A)', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05', [{ taskId: '3', type: 'FS' }]),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
        createTask('3', '2026-01-11', '2026-01-15', [{ taskId: '2', type: 'FS' }]),
      ];
      const result = detectCycles(tasks);
      expect(result.hasCycle).toBe(true);
    });
  });

  describe('calculateSuccessorDate', () => {
    const jan1 = new Date(Date.UTC(2026, 0, 1)); // 2026-01-01
    const jan5 = new Date(Date.UTC(2026, 0, 5)); // 2026-01-05

    it('should calculate FS (finish-to-start) with no lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'FS', 0);
      expect(result.getUTCFullYear()).toBe(2026);
      expect(result.getUTCMonth()).toBe(0);
      expect(result.getUTCDate()).toBe(5); // Starts when predecessor finishes
    });

    it('should calculate FS with positive lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'FS', 2);
      expect(result.getUTCDate()).toBe(7); // 2 days after predecessor finishes
    });

    it('should calculate FS with negative lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'FS', -2);
      expect(result.getUTCDate()).toBe(3); // 2 days before predecessor finishes
    });

    it('should calculate SS (start-to-start) with no lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'SS', 0);
      expect(result.getUTCDate()).toBe(1); // Starts when predecessor starts
    });

    it('should calculate SS with positive lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'SS', 3);
      expect(result.getUTCDate()).toBe(4); // 3 days after predecessor starts
    });

    it('should calculate FF (finish-to-finish) with no lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'FF', 0);
      expect(result.getUTCDate()).toBe(5); // Finishes when predecessor finishes
    });

    it('should calculate FF with positive lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'FF', 1);
      expect(result.getUTCDate()).toBe(6); // 1 day after predecessor finishes
    });

    it('should calculate SF (start-to-finish) with no lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'SF', 0);
      expect(result.getUTCDate()).toBe(1); // Finishes when predecessor starts
    });

    it('should calculate SF with positive lag', () => {
      const result = calculateSuccessorDate(jan1, jan5, 'SF', 4);
      expect(result.getUTCDate()).toBe(5); // 4 days after predecessor starts
    });
  });

  describe('validateDependencies', () => {
    it('should return valid for tasks with no dependencies', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10'),
      ];
      const result = validateDependencies(tasks);
      expect(result.isValid).toBe(true);
      expect(result.errors).toEqual([]);
    });

    it('should return valid for valid dependencies', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
      ];
      const result = validateDependencies(tasks);
      expect(result.isValid).toBe(true);
    });

    it('should detect missing predecessor task', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05', [{ taskId: '999', type: 'FS' }]),
      ];
      const result = validateDependencies(tasks);
      expect(result.isValid).toBe(false);
      expect(result.errors).toHaveLength(1);
      expect(result.errors[0].type).toBe('missing-task');
      expect(result.errors[0].taskId).toBe('1');
    });

    it('should detect cycles', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05', [{ taskId: '2', type: 'FS' }]),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
      ];
      const result = validateDependencies(tasks);
      expect(result.isValid).toBe(false);
      expect(result.errors.some(e => e.type === 'cycle')).toBe(true);
    });

    it('should detect multiple errors', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05', [{ taskId: '999', type: 'FS' }]),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS' }]),
        createTask('3', '2026-01-11', '2026-01-15', [{ taskId: '888', type: 'FS' }]),
      ];
      const result = validateDependencies(tasks);
      expect(result.isValid).toBe(false);
      expect(result.errors.length).toBeGreaterThanOrEqual(2);
    });
  });

  describe('getAllDependencyEdges', () => {
    it('should return empty array for no dependencies', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10'),
      ];
      const result = getAllDependencyEdges(tasks);
      expect(result).toEqual([]);
    });

    it('should extract single dependency edge', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FS', lag: 2 }]),
      ];
      const result = getAllDependencyEdges(tasks);
      expect(result).toHaveLength(1);
      expect(result[0]).toEqual({
        predecessorId: '1',
        successorId: '2',
        type: 'FS',
        lag: 2,
      });
    });

    it('should extract multiple dependency edges', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [
          { taskId: '1', type: 'FS' },
          { taskId: '3', type: 'SS', lag: -1 },
        ]),
        createTask('3', '2026-01-11', '2026-01-15'),
      ];
      const result = getAllDependencyEdges(tasks);
      expect(result).toHaveLength(2);
    });

    it('should default lag to 0 when not specified', () => {
      const tasks = [
        createTask('1', '2026-01-01', '2026-01-05'),
        createTask('2', '2026-01-06', '2026-01-10', [{ taskId: '1', type: 'FF' }]),
      ];
      const result = getAllDependencyEdges(tasks);
      expect(result[0].lag).toBe(0);
    });
  });
});
```

**Key patterns:**
- Group tests by function using describe blocks
- Use helper function (createTask) to reduce boilerplate
- Test edge cases (empty arrays, missing tasks, cycles)
- Test all four link types (FS, SS, FF, SF)
- Test positive, negative, and zero lag values
- Follow existing test patterns from dateUtils.test.ts and geometry.test.ts
  </action>
  <verify>
Run `npm test` to verify all new tests pass.
  </verify>
  <done>
dependencyUtils.test.ts file exists with comprehensive test coverage for all exported functions, all tests pass, and test coverage includes cycle detection, link type calculations, and validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update demo page with dependency examples</name>
  <files>packages/website/src/app/page.tsx</files>
  <action>
Update packages/website/src/app/page.tsx to showcase task dependencies:

Add new sample tasks with dependencies after the existing sample tasks. Replace or add to the existing task array:

```typescript
  // Sample tasks with dependencies demonstrating all link types
  const [dependencyTasks, setDependencyTasks] = useState([
    // Foundation tasks (no dependencies)
    {
      id: 'foundation-1',
      name: 'Foundation A',
      startDate: '2026-02-01',
      endDate: '2026-02-03',
      color: '#3b82f6',
    },
    {
      id: 'foundation-2',
      name: 'Foundation B',
      startDate: '2026-02-02',
      endDate: '2026-02-04',
      color: '#8b5cf6',
    },

    // FS (Finish-to-Start) dependency
    {
      id: 'fs-task',
      name: 'FS: Starts after A',
      startDate: '2026-02-04',
      endDate: '2026-02-06',
      color: '#10b981',
      dependencies: [{ taskId: 'foundation-1', type: 'FS' as const }],
    },

    // SS (Start-to-Start) dependency
    {
      id: 'ss-task',
      name: 'SS: Starts with B',
      startDate: '2026-02-02',
      endDate: '2026-02-05',
      color: '#f59e0b',
      dependencies: [{ taskId: 'foundation-2', type: 'SS' as const }],
    },

    // FF (Finish-to-Finish) dependency
    {
      id: 'ff-task',
      name: 'FF: Finishes with A',
      startDate: '2026-02-02',
      endDate: '2026-02-03',
      color: '#ef4444',
      dependencies: [{ taskId: 'foundation-1', type: 'FF' as const }],
    },

    // SF (Start-to-Finish) dependency (rare but supported)
    {
      id: 'sf-task',
      name: 'SF: Finishes when B starts',
      startDate: '2026-02-01',
      endDate: '2026-02-02',
      color: '#ec4899',
      dependencies: [{ taskId: 'foundation-2', type: 'SF' as const }],
    },

    // Lag examples
    {
      id: 'lag-positive',
      name: 'Lag +2 days',
      startDate: '2026-02-06',
      endDate: '2026-02-08',
      color: '#06b6d4',
      dependencies: [{ taskId: 'foundation-1', type: 'FS' as const, lag: 2 }],
    },

    {
      id: 'lag-negative',
      name: 'Lag -1 day',
      startDate: '2026-02-02',
      endDate: '2026-02-04',
      color: '#84cc16',
      dependencies: [{ taskId: 'foundation-2', type: 'SS' as const, lag: -1 }],
    },

    // Circular dependency (for demonstration - highlighted in red)
    {
      id: 'cycle-a',
      name: 'Cycle A',
      startDate: '2026-02-08',
      endDate: '2026-02-10',
      color: '#f97316',
      dependencies: [{ taskId: 'cycle-b', type: 'FS' as const }],
    },
    {
      id: 'cycle-b',
      name: 'Cycle B',
      startDate: '2026-02-08',
      endDate: '2026-02-10',
      color: '#a855f7',
      dependencies: [{ taskId: 'cycle-a', type: 'FS' as const }],
    },
  ]);
```

Add a second GanttChart component to showcase dependencies:

```tsx
          {/* Dependencies Demo */}
          <div className={styles.section}>
            <h2 className={styles.sectionTitle}>Task Dependencies</h2>
            <p className={styles.sectionDescription}>
              Tasks can have dependencies with 4 link types (FS, SS, FF, SF) and optional lag.
              Circular dependencies are highlighted in red.
            </p>
            <GanttChart
              tasks={dependencyTasks}
              onChange={setDependencyTasks}
              dayWidth={50}
              rowHeight={50}
              onValidateDependencies={(result) => {
                if (!result.isValid) {
                  console.log('Dependency validation:', result.errors);
                }
              }}
            />
          </div>
```

Update the imports at the top to include TaskDependency type if needed for the demo.

**Note:** Keep the original simple demo (7 tasks) and add the dependencies demo as a second section.
  </action>
  <verify>
Run `npm run dev` in packages/website and visit localhost:3000 to verify:
1. Dependency lines are visible between tasks
2. Circular dependencies (cycle-a, cycle-b) are highlighted in red
3. All four link types are demonstrated
4. Positive and negative lag examples are shown
  </verify>
  <done>
Demo page includes dependency examples with all link types visible, circular dependencies highlighted in red, and the page loads without errors.
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Verify dependencies functionality end-to-end</name>
  <what-built>Complete dependency system with type definitions, utilities, SVG visualization, integration, and tests</what-built>
  <how-to-verify>
1. Run `npm test` - all tests including new dependencyUtils tests should pass
2. Run `npm run dev` from packages/website directory
3. Visit http://localhost:3000
4. Scroll to "Task Dependencies" section
5. Verify:
   - Curved lines connect dependent tasks
   - Arrow heads appear at line endpoints
   - Cycle A and Cycle B have red lines (circular dependency)
   - Try dragging "FS: Starts after A" - it should not move earlier than "Foundation A"
   - Try resizing the same task - resize should work (only move is blocked)
   - Check browser console for validation errors
6. Run `npm run build` in packages/gantt-lib - build should succeed
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. All unit tests pass: `npm test` (including new dependencyUtils tests)
2. Demo page loads without errors
3. Dependency lines are visible and correct
4. Circular dependencies are highlighted
5. Drag validation works (move blocked, resize allowed)
6. Library builds successfully: `npm run build` from packages/gantt-lib
7. TypeScript compiles without errors
</verification>

<success_criteria>
1. 20+ unit tests for dependency utilities (all passing)
2. Demo page shows all 4 link types with visual examples
3. Circular dependency example highlighted in red
4. Dependency validation works during drag operations
5. All existing tests still pass (no regressions)
6. Zero breaking changes to existing API
7. Documentation comments explain each link type
8. Console logs validation results for demo
</success_criteria>

<output>
After completion, create `.planning/phases/06-dependencies/06-04-SUMMARY.md`
</output>
